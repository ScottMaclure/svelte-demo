<:Window on:popstate='doPopState(event)'/>

<div class="helloWorld">

  <nav class="navLinks">
    <a href="#{{routes.splash}}" on:click='doRoute(event)'>Home</a>
    <a href="#{{routes.listUsers}}" on:click='doRoute(event)'>List Users</a>
    <a href="#{{routes.testBroken}}" on:click='doRoute(event)'>Test Broken</a>
  </nav>

  <!-- TODO refactor into component -->
  {{#if messages.length > 0}}
    <div class="messages">
      {{#each messages as message}}
        <div class="message">
          <div>{{message.title}}</div>
          <div>{{message.content}}</div>
        </div>
      {{/each}}
    </div>
  {{/if}}

  {{#if route === routes.splash}}

    <Splash name='{{name}}' count='{{count}}'/>

  {{elseif route === routes.listUsers}}

    <ListUsers
      isLoading='{{isLoading}}'
      items='{{items}}'
      sorting='{{sorting}}'
      filter='{{filter}}'
      on:filterData='fire("filterData", event)'
      on:requestData='requestData()'
      on:editItem='editItem(event)'
      on:deleteItem='fire("deleteItem", event)'
      on:updateSorting='fire("updateSorting", event)'
    />

  {{elseif route === routes.editUser}}

      <EditUser
        items='{{items}}'
        item='{{itemToEdit}}'
        on:requestData='requestData()'
        on:cancelEdit='cancelEdit(event)'
        on:saveUser='fire("saveUser", event)'
      />

  {{else}}

    <p>No route found for '{{route}}'</p>

  {{/if}}

</div>

<script>
  import Config from './config.js'
  import Splash from './Splash.html'
  import ListUsers from './ListUsers.html'
  import EditUser from './EditUser.html'

  const getRouteParts = (href) => {
    // Break up Foo/bar/blah/etc/1 into parts. Individual routes know how to read their own subroutes.
    return (href || location.hash.slice(1) || Config.routes.default).split('/')
  }

  export default {
    components: {
      Config,
      Splash,
      ListUsers,
      EditUser
    },
    // oncreate () {
    //   // this.set({ routeParts: getRouteParts() }) // Set initial view. (default data removes need for this.)
    //   console.log('SvelteDemoApp oncreate')
    // },
    data () {
      return {
        routeParts: getRouteParts(),
        routes: Config.routes,
        isLoading: false,
        messages: [],
        count: 0,
        items: [],
        filter: '',
        sorting: {} // TODO Defining data structures at multiple levels...
      }
    },
    computed: {
      route: (routeParts) => {
        if (!routeParts) {
          return Config.routes.default // defensive?
        }
        return routeParts[0] // the zero-eth part is always the main "view" of the route.
      },
      itemToEdit: (items, routeParts) => {
        // routeParts should always be defined due to oncreate method already running?
        let foundItem = items.find(item => {
          return item.id.toString() === routeParts[1] // See editItem.
        })
        return foundItem || {}
      }
    },
    methods: {
        /**
         * Handles events triggered from a) dom nodes or b) semantic events fire'd components.
         */
        doRoute: function (event) {
          if (event.preventDefault) { event.preventDefault() } // semantic events won't have dom events... why should this be here then?
          let href = event.target ? event.target.getAttribute('href').slice(1) : event.href // remove hash from href attributes
          let routeParts = getRouteParts(href) // for semantic events
          window.history.pushState(routeParts, routeParts[0], ('#' + href)) // FIXME Adding the hash here...
          this.set({ routeParts: routeParts })
        },
        doPopState: function () {
          // TODO Repeated code from main.js.
          let routeParts = getRouteParts()
          this.set({ routeParts: routeParts })
        },
        editItem: function (event) {
          // TODO Could check for populated items array at this point?
          // So, this means that Users component knows nothing about route generation, it just fired up the id.
          this.doRoute({ href: Config.routes.editUser+'/'+event.id }) // FIXME weaksauce route url construction.
        },
        cancelEdit: function () {
          this.doRoute({ href: Config.routes.listUsers})
        },
        requestData: function () {
          // TODO isLoading... localise to Users component?
          this.set({ isLoading: true })
          this.fire('requestData')
        },
        setData: function (data) {
          data.isLoading = false
          data.originalItems = data.items.slice() // make a shallow copy for filtering etc.
          this.set(data)
        }
    }
  }
</script>
<style>
  .helloWorld {
    background-color: var(--base-background-color, #00f);
    padding: var(--spacing-vertical-normal);
  }
  .helloWorld nav {
    margin-bottom: var(--spacing-vertical-normal);
  }
  .helloWorld .navLinks a {
    margin-right: var(--spacing-horizontal-small);
  }
</style>